<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>lara_rgbd: evaluate_rpe.py Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">evaluate_rpe.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="evaluate__rpe_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespaceevaluate__rpe.html">00001</a> <span class="comment">#!/usr/bin/python</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="keyword">import</span> argparse
<a name="l00004"></a>00004 <span class="keyword">import</span> random
<a name="l00005"></a>00005 <span class="keyword">import</span> numpy
<a name="l00006"></a>00006 <span class="keyword">import</span> sys
<a name="l00007"></a>00007 
<a name="l00008"></a><a class="code" href="namespaceevaluate__rpe.html#ae2f9a1d1fa0fc3e16409f219877d8f3f">00008</a> _EPS = numpy.finfo(float).eps * 4.0
<a name="l00009"></a>00009 
<a name="l00010"></a><a class="code" href="namespaceevaluate__rpe.html#a4d361c484e4fdee9680eb51fe356c21f">00010</a> <span class="keyword">def </span><a class="code" href="namespaceevaluate__rpe.html#a4d361c484e4fdee9680eb51fe356c21f">transform44</a>(l):
<a name="l00011"></a>00011     t = l[1:4]
<a name="l00012"></a>00012     q = numpy.array(l[4:8], dtype=numpy.float64, copy=<span class="keyword">True</span>)
<a name="l00013"></a>00013     nq = numpy.dot(q, q)
<a name="l00014"></a>00014     <span class="keywordflow">if</span> nq &lt; _EPS:
<a name="l00015"></a>00015         <span class="keywordflow">return</span> numpy.array((
<a name="l00016"></a>00016         (                1.0,                 0.0,                 0.0, t[0])
<a name="l00017"></a>00017         (                0.0,                 1.0,                 0.0, t[1])
<a name="l00018"></a>00018         (                0.0,                 0.0,                 1.0, t[2])
<a name="l00019"></a>00019         (                0.0,                 0.0,                 0.0, 1.0)
<a name="l00020"></a>00020         ), dtype=numpy.float64)
<a name="l00021"></a>00021     q *= numpy.sqrt(2.0 / nq)
<a name="l00022"></a>00022     q = numpy.outer(q, q)
<a name="l00023"></a>00023     <span class="keywordflow">return</span> numpy.array((
<a name="l00024"></a>00024         (1.0-q[1, 1]-q[2, 2],     q[0, 1]-q[2, 3],     q[0, 2]+q[1, 3], t[0]),
<a name="l00025"></a>00025         (    q[0, 1]+q[2, 3], 1.0-q[0, 0]-q[2, 2],     q[1, 2]-q[0, 3], t[1]),
<a name="l00026"></a>00026         (    q[0, 2]-q[1, 3],     q[1, 2]+q[0, 3], 1.0-q[0, 0]-q[1, 1], t[2]),
<a name="l00027"></a>00027         (                0.0,                 0.0,                 0.0, 1.0)
<a name="l00028"></a>00028         ), dtype=numpy.float64)
<a name="l00029"></a>00029 
<a name="l00030"></a><a class="code" href="namespaceevaluate__rpe.html#ab83a4ad6c2bb23eb848257400e3af2de">00030</a> <span class="keyword">def </span><a class="code" href="namespaceevaluate__rpe.html#ab83a4ad6c2bb23eb848257400e3af2de">read_trajectory</a>(filename, matrix=True):
<a name="l00031"></a>00031     file = open(filename)
<a name="l00032"></a>00032     data = file.read()
<a name="l00033"></a>00033     lines = data.replace(<span class="stringliteral">&quot;,&quot;</span>,<span class="stringliteral">&quot; &quot;</span>).replace(<span class="stringliteral">&quot;\t&quot;</span>,<span class="stringliteral">&quot; &quot;</span>).split(<span class="stringliteral">&quot;\n&quot;</span>) 
<a name="l00034"></a>00034     list = [[float(v.strip()) <span class="keywordflow">for</span> v <span class="keywordflow">in</span> line.split(<span class="stringliteral">&quot; &quot;</span>) <span class="keywordflow">if</span> v.strip()!=<span class="stringliteral">&quot;&quot;</span>] <span class="keywordflow">for</span> line <span class="keywordflow">in</span> lines <span class="keywordflow">if</span> len(line)&gt;0 <span class="keywordflow">and</span> line[0]!=<span class="stringliteral">&quot;#&quot;</span>]
<a name="l00035"></a>00035     list_ok = []
<a name="l00036"></a>00036     <span class="keywordflow">for</span> i,l <span class="keywordflow">in</span> enumerate(list):
<a name="l00037"></a>00037         <span class="keywordflow">if</span> l[4:8]==[0,0,0,0]:
<a name="l00038"></a>00038             <span class="keywordflow">continue</span>
<a name="l00039"></a>00039         isnan = <span class="keyword">False</span>
<a name="l00040"></a>00040         <span class="keywordflow">for</span> v <span class="keywordflow">in</span> l:
<a name="l00041"></a>00041             <span class="keywordflow">if</span> numpy.isnan(v): 
<a name="l00042"></a>00042                 isnan = <span class="keyword">True</span>
<a name="l00043"></a>00043                 <span class="keywordflow">break</span>
<a name="l00044"></a>00044         <span class="keywordflow">if</span> isnan:
<a name="l00045"></a>00045             sys.stderr.write(<span class="stringliteral">&quot;Warning: line %d of file &#39;%s&#39; has NaNs, skipping line\n&quot;</span>%(i,filename))
<a name="l00046"></a>00046             <span class="keywordflow">continue</span>
<a name="l00047"></a>00047         list_ok.append(l)
<a name="l00048"></a>00048     <span class="keywordflow">if</span> matrix :
<a name="l00049"></a>00049       traj = dict([(l[0],<a class="code" href="namespaceevaluate__rpe.html#a4d361c484e4fdee9680eb51fe356c21f">transform44</a>(l[0:])) <span class="keywordflow">for</span> l <span class="keywordflow">in</span> list_ok])
<a name="l00050"></a>00050     <span class="keywordflow">else</span>:
<a name="l00051"></a>00051       traj = dict([(l[0],l[1:8]) <span class="keywordflow">for</span> l <span class="keywordflow">in</span> list_ok])
<a name="l00052"></a>00052     <span class="keywordflow">return</span> traj
<a name="l00053"></a>00053 
<a name="l00054"></a><a class="code" href="namespaceevaluate__rpe.html#a417ab4ce2cee5f07146d93e9e5eb0cd2">00054</a> <span class="keyword">def </span><a class="code" href="namespaceevaluate__rpe.html#a417ab4ce2cee5f07146d93e9e5eb0cd2">find_closest_index</a>(L,t):
<a name="l00055"></a>00055     beginning = 0
<a name="l00056"></a>00056     difference = abs(L[0] - t)
<a name="l00057"></a>00057     best = 0
<a name="l00058"></a>00058     end = len(L)
<a name="l00059"></a>00059     <span class="keywordflow">while</span> beginning &lt; end:
<a name="l00060"></a>00060         middle = int((end+beginning)/2)
<a name="l00061"></a>00061         <span class="keywordflow">if</span> abs(L[middle] - t) &lt; difference:
<a name="l00062"></a>00062             difference = abs(L[middle] - t)
<a name="l00063"></a>00063             best = middle
<a name="l00064"></a>00064         <span class="keywordflow">if</span> t == L[middle]:
<a name="l00065"></a>00065             <span class="keywordflow">return</span> middle
<a name="l00066"></a>00066         <span class="keywordflow">elif</span> L[middle] &gt; t:
<a name="l00067"></a>00067             end = middle
<a name="l00068"></a>00068         <span class="keywordflow">else</span>:
<a name="l00069"></a>00069             beginning = middle + 1
<a name="l00070"></a>00070     <span class="keywordflow">return</span> best
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="namespaceevaluate__rpe.html#a7183e2ecbad3bf32a6788d3fdad139b1">00072</a> <span class="keyword">def </span><a class="code" href="namespaceevaluate__rpe.html#a7183e2ecbad3bf32a6788d3fdad139b1">ominus</a>(a,b):
<a name="l00073"></a>00073     <span class="keywordflow">return</span> numpy.dot(numpy.linalg.inv(a),b)
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="namespaceevaluate__rpe.html#abd2f8c5cc1b50325a3d341427897f1cc">00075</a> <span class="keyword">def </span><a class="code" href="namespaceevaluate__rpe.html#abd2f8c5cc1b50325a3d341427897f1cc">scale</a>(a,scalar):
<a name="l00076"></a>00076     <span class="keywordflow">return</span> numpy.array(
<a name="l00077"></a>00077         [[a[0,0], a[0,1], a[0,2], a[0,3]*scalar],
<a name="l00078"></a>00078          [a[1,0], a[1,1], a[1,2], a[1,3]*scalar],
<a name="l00079"></a>00079          [a[2,0], a[2,1], a[2,2], a[2,3]*scalar],
<a name="l00080"></a>00080          [a[3,0], a[3,1], a[3,2], a[3,3]]]
<a name="l00081"></a>00081                        )
<a name="l00082"></a>00082 
<a name="l00083"></a><a class="code" href="namespaceevaluate__rpe.html#ae9bb8e1fb57156f331d1c9e487960f07">00083</a> <span class="keyword">def </span><a class="code" href="namespaceevaluate__rpe.html#ae9bb8e1fb57156f331d1c9e487960f07">compute_distance</a>(transform):
<a name="l00084"></a>00084     <span class="keywordflow">return</span> numpy.linalg.norm(transform[0:3,3])
<a name="l00085"></a>00085 
<a name="l00086"></a><a class="code" href="namespaceevaluate__rpe.html#a30aca29d159f5dd8e752eeaa4044a5f2">00086</a> <span class="keyword">def </span><a class="code" href="namespaceevaluate__rpe.html#a30aca29d159f5dd8e752eeaa4044a5f2">compute_angle</a>(transform):
<a name="l00087"></a>00087     <span class="comment"># an invitation to 3-d vision, p 27</span>
<a name="l00088"></a>00088     <span class="keywordflow">return</span> numpy.arccos( min(1,max(-1, (numpy.trace(transform[0:3,0:3]) - 1)/2) ))
<a name="l00089"></a>00089 
<a name="l00090"></a><a class="code" href="namespaceevaluate__rpe.html#a7c07ec370c481a7257f93e84701795e9">00090</a> <span class="keyword">def </span><a class="code" href="namespaceevaluate__rpe.html#a7c07ec370c481a7257f93e84701795e9">distances_along_trajectory</a>(traj):
<a name="l00091"></a>00091     keys = traj.keys()
<a name="l00092"></a>00092     keys.sort()
<a name="l00093"></a>00093     motion = [<a class="code" href="namespaceevaluate__rpe.html#a7183e2ecbad3bf32a6788d3fdad139b1">ominus</a>(traj[keys[i+1]],traj[keys[i]]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(keys)-1)]
<a name="l00094"></a>00094     distances = [0]
<a name="l00095"></a>00095     sum = 0
<a name="l00096"></a>00096     <span class="keywordflow">for</span> t <span class="keywordflow">in</span> motion:
<a name="l00097"></a>00097         sum += <a class="code" href="namespaceevaluate__rpe.html#ae9bb8e1fb57156f331d1c9e487960f07">compute_distance</a>(t)
<a name="l00098"></a>00098         distances.append(sum)
<a name="l00099"></a>00099     <span class="keywordflow">return</span> distances
<a name="l00100"></a>00100     
<a name="l00101"></a><a class="code" href="namespaceevaluate__rpe.html#a89859a4c6fe7610ee83e953429fe3f26">00101</a> <span class="keyword">def </span><a class="code" href="namespaceevaluate__rpe.html#a89859a4c6fe7610ee83e953429fe3f26">rotations_along_trajectory</a>(traj,scale):
<a name="l00102"></a>00102     keys = traj.keys()
<a name="l00103"></a>00103     keys.sort()
<a name="l00104"></a>00104     motion = [<a class="code" href="namespaceevaluate__rpe.html#a7183e2ecbad3bf32a6788d3fdad139b1">ominus</a>(traj[keys[i+1]],traj[keys[i]]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(keys)-1)]
<a name="l00105"></a>00105     distances = [0]
<a name="l00106"></a>00106     sum = 0
<a name="l00107"></a>00107     <span class="keywordflow">for</span> t <span class="keywordflow">in</span> motion:
<a name="l00108"></a>00108         sum += <a class="code" href="namespaceevaluate__rpe.html#a30aca29d159f5dd8e752eeaa4044a5f2">compute_angle</a>(t)*scale
<a name="l00109"></a>00109         distances.append(sum)
<a name="l00110"></a>00110     <span class="keywordflow">return</span> distances
<a name="l00111"></a>00111     
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="namespaceevaluate__rpe.html#a8f86ada4c8601d2ee8511fef28455af8">00113</a> <span class="keyword">def </span><a class="code" href="namespaceevaluate__rpe.html#a8f86ada4c8601d2ee8511fef28455af8">evaluate_trajectory</a>(traj_gt,traj_est,param_max_pairs=10000,param_fixed_delta=False,param_delta=1.00,param_delta_unit=&quot;s&quot;,param_offset=0.00,param_scale=1.00):
<a name="l00114"></a>00114     stamps_gt = <a class="code" href="namespacegenerate__registered__pointcloud.html#accd6c148b0a675d04fa99106c1b74e57">list</a>(traj_gt.keys())
<a name="l00115"></a>00115     stamps_est = <a class="code" href="namespacegenerate__registered__pointcloud.html#accd6c148b0a675d04fa99106c1b74e57">list</a>(traj_est.keys())
<a name="l00116"></a>00116     stamps_gt.sort()
<a name="l00117"></a>00117     stamps_est.sort()
<a name="l00118"></a>00118     
<a name="l00119"></a>00119     stamps_est_return = []
<a name="l00120"></a>00120     <span class="keywordflow">for</span> t_est <span class="keywordflow">in</span> stamps_est:
<a name="l00121"></a>00121         t_gt = stamps_gt[<a class="code" href="namespaceevaluate__rpe.html#a417ab4ce2cee5f07146d93e9e5eb0cd2">find_closest_index</a>(stamps_gt,t_est + param_offset)]
<a name="l00122"></a>00122         t_est_return = stamps_est[<a class="code" href="namespaceevaluate__rpe.html#a417ab4ce2cee5f07146d93e9e5eb0cd2">find_closest_index</a>(stamps_est,t_gt - param_offset)]
<a name="l00123"></a>00123         t_gt_return = stamps_gt[<a class="code" href="namespaceevaluate__rpe.html#a417ab4ce2cee5f07146d93e9e5eb0cd2">find_closest_index</a>(stamps_gt,t_est_return + param_offset)]
<a name="l00124"></a>00124         <span class="keywordflow">if</span> <span class="keywordflow">not</span> t_est_return <span class="keywordflow">in</span> stamps_est_return:
<a name="l00125"></a>00125             stamps_est_return.append(t_est_return)
<a name="l00126"></a>00126     if(len(stamps_est_return)&lt;2):
<a name="l00127"></a>00127         <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&quot;Number of overlap in the timestamps is too small. Did you run the evaluation on the right files?&quot;</span>)
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <span class="keywordflow">if</span> param_delta_unit==<span class="stringliteral">&quot;s&quot;</span>:
<a name="l00130"></a>00130         index_est = <a class="code" href="namespacegenerate__registered__pointcloud.html#accd6c148b0a675d04fa99106c1b74e57">list</a>(traj_est.keys())
<a name="l00131"></a>00131         index_est.sort()
<a name="l00132"></a>00132     <span class="keywordflow">elif</span> param_delta_unit==<span class="stringliteral">&quot;m&quot;</span>:
<a name="l00133"></a>00133         index_est = <a class="code" href="namespaceevaluate__rpe.html#a7c07ec370c481a7257f93e84701795e9">distances_along_trajectory</a>(traj_est)
<a name="l00134"></a>00134     <span class="keywordflow">elif</span> param_delta_unit==<span class="stringliteral">&quot;rad&quot;</span>:
<a name="l00135"></a>00135         index_est = <a class="code" href="namespaceevaluate__rpe.html#a89859a4c6fe7610ee83e953429fe3f26">rotations_along_trajectory</a>(traj_est,1)
<a name="l00136"></a>00136     <span class="keywordflow">elif</span> param_delta_unit==<span class="stringliteral">&quot;deg&quot;</span>:
<a name="l00137"></a>00137         index_est = <a class="code" href="namespaceevaluate__rpe.html#a89859a4c6fe7610ee83e953429fe3f26">rotations_along_trajectory</a>(traj_est,180/numpy.pi)
<a name="l00138"></a>00138     <span class="keywordflow">elif</span> param_delta_unit==<span class="stringliteral">&quot;f&quot;</span>:
<a name="l00139"></a>00139         index_est = range(len(traj_est))
<a name="l00140"></a>00140     <span class="keywordflow">else</span>:
<a name="l00141"></a>00141         <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&quot;Unknown unit for delta: &#39;%s&#39;&quot;</span>%param_delta_unit)
<a name="l00142"></a>00142 
<a name="l00143"></a>00143     <span class="keywordflow">if</span> <span class="keywordflow">not</span> param_fixed_delta:
<a name="l00144"></a>00144         if(param_max_pairs==0 <span class="keywordflow">or</span> len(traj_est)&lt;numpy.sqrt(param_max_pairs)):
<a name="l00145"></a>00145             pairs = [(i,j) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(traj_est)) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(len(traj_est))]
<a name="l00146"></a>00146         <span class="keywordflow">else</span>:
<a name="l00147"></a>00147             pairs = [(random.randint(0,len(traj_est)-1),random.randint(0,len(traj_est)-1)) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(param_max_pairs)]
<a name="l00148"></a>00148     <span class="keywordflow">else</span>:
<a name="l00149"></a>00149         pairs = []
<a name="l00150"></a>00150         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(traj_est)):
<a name="l00151"></a>00151             j = <a class="code" href="namespaceevaluate__rpe.html#a417ab4ce2cee5f07146d93e9e5eb0cd2">find_closest_index</a>(index_est,index_est[i] + param_delta)
<a name="l00152"></a>00152             <span class="keywordflow">if</span> j!=len(traj_est)-1: 
<a name="l00153"></a>00153                 pairs.append((i,j))
<a name="l00154"></a>00154         if(param_max_pairs!=0 <span class="keywordflow">and</span> len(pairs)&gt;param_max_pairs):
<a name="l00155"></a>00155             pairs = random.sample(pairs,param_max_pairs)
<a name="l00156"></a>00156     
<a name="l00157"></a>00157     gt_interval = numpy.median([s-t <span class="keywordflow">for</span> s,t <span class="keywordflow">in</span> zip(stamps_gt[1:],stamps_gt[:-1])])
<a name="l00158"></a>00158     gt_max_time_difference = 2*gt_interval
<a name="l00159"></a>00159     
<a name="l00160"></a>00160     result = []
<a name="l00161"></a>00161     <span class="keywordflow">for</span> i,j <span class="keywordflow">in</span> pairs:
<a name="l00162"></a>00162         stamp_est_0 = stamps_est[i]
<a name="l00163"></a>00163         stamp_est_1 = stamps_est[j]
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         stamp_gt_0 = stamps_gt[ <a class="code" href="namespaceevaluate__rpe.html#a417ab4ce2cee5f07146d93e9e5eb0cd2">find_closest_index</a>(stamps_gt,stamp_est_0 + param_offset) ]
<a name="l00166"></a>00166         stamp_gt_1 = stamps_gt[ <a class="code" href="namespaceevaluate__rpe.html#a417ab4ce2cee5f07146d93e9e5eb0cd2">find_closest_index</a>(stamps_gt,stamp_est_1 + param_offset) ]
<a name="l00167"></a>00167         
<a name="l00168"></a>00168         if(abs(stamp_gt_0 - (stamp_est_0 + param_offset)) &gt; gt_max_time_difference  <span class="keywordflow">or</span>
<a name="l00169"></a>00169            abs(stamp_gt_1 - (stamp_est_1 + param_offset)) &gt; gt_max_time_difference):
<a name="l00170"></a>00170             <span class="keywordflow">continue</span>
<a name="l00171"></a>00171         
<a name="l00172"></a>00172         error44 = <a class="code" href="namespaceevaluate__rpe.html#a7183e2ecbad3bf32a6788d3fdad139b1">ominus</a>(  <a class="code" href="namespaceevaluate__rpe.html#abd2f8c5cc1b50325a3d341427897f1cc">scale</a>(
<a name="l00173"></a>00173                            <a class="code" href="namespaceevaluate__rpe.html#a7183e2ecbad3bf32a6788d3fdad139b1">ominus</a>( traj_est[stamp_est_1], traj_est[stamp_est_0] ),param_scale),
<a name="l00174"></a>00174                            <a class="code" href="namespaceevaluate__rpe.html#a7183e2ecbad3bf32a6788d3fdad139b1">ominus</a>( traj_gt[stamp_gt_1], traj_gt[stamp_gt_0] ) )
<a name="l00175"></a>00175         
<a name="l00176"></a>00176         trans = <a class="code" href="namespaceevaluate__rpe.html#ae9bb8e1fb57156f331d1c9e487960f07">compute_distance</a>(error44)
<a name="l00177"></a>00177         rot = <a class="code" href="namespaceevaluate__rpe.html#a30aca29d159f5dd8e752eeaa4044a5f2">compute_angle</a>(error44)
<a name="l00178"></a>00178         
<a name="l00179"></a>00179         result.append([stamp_est_0,stamp_est_1,stamp_gt_0,stamp_gt_1,trans,rot])
<a name="l00180"></a>00180         
<a name="l00181"></a>00181     <span class="keywordflow">if</span> len(result)&lt;2:
<a name="l00182"></a>00182         <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&quot;Couldn&#39;t find matching timestamp pairs between groundtruth and estimated trajectory!&quot;</span>)
<a name="l00183"></a>00183         
<a name="l00184"></a>00184     <span class="keywordflow">return</span> result
<a name="l00185"></a>00185 
<a name="l00186"></a><a class="code" href="namespaceevaluate__rpe.html#a1704160de0b882145e27dc3ece4c1325">00186</a> <span class="keyword">def </span><a class="code" href="namespaceevaluate__rpe.html#a1704160de0b882145e27dc3ece4c1325">percentile</a>(seq,q):
<a name="l00187"></a>00187     seq_sorted = <a class="code" href="namespacegenerate__registered__pointcloud.html#accd6c148b0a675d04fa99106c1b74e57">list</a>(seq)
<a name="l00188"></a>00188     seq_sorted.sort()
<a name="l00189"></a>00189     <span class="keywordflow">return</span> seq_sorted[int((len(seq_sorted)-1)*q)]
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 <span class="keywordflow">if</span> __name__ == <span class="stringliteral">&#39;__main__&#39;</span>:
<a name="l00192"></a>00192     random.seed(0)
<a name="l00193"></a>00193 
<a name="l00194"></a><a class="code" href="namespaceevaluate__rpe.html#a44b450933544c78d01461a6c21241ff4">00194</a>     parser = argparse.ArgumentParser(description=<span class="stringliteral">&#39;&#39;&#39;</span>
<a name="l00195"></a>00195 <span class="stringliteral">    This script computes the relative pose error from the ground truth trajectory and the estimated trajectory. </span>
<a name="l00196"></a>00196 <span class="stringliteral">    &#39;&#39;&#39;</span>)
<a name="l00197"></a>00197     parser.add_argument(<span class="stringliteral">&#39;groundtruth_file&#39;</span>, help=<span class="stringliteral">&#39;ground-truth trajectory file (format: &quot;timestamp tx ty tz qx qy qz qw&quot;)&#39;</span>)
<a name="l00198"></a>00198     parser.add_argument(<span class="stringliteral">&#39;estimated_file&#39;</span>, help=<span class="stringliteral">&#39;estimated trajectory file (format: &quot;timestamp tx ty tz qx qy qz qw&quot;)&#39;</span>)
<a name="l00199"></a>00199     parser.add_argument(<span class="stringliteral">&#39;--max_pairs&#39;</span>, help=<span class="stringliteral">&#39;maximum number of pose comparisons (default: 10000, set to zero to disable downsampling)&#39;</span>, default=10000)
<a name="l00200"></a>00200     parser.add_argument(<span class="stringliteral">&#39;--fixed_delta&#39;</span>, help=<span class="stringliteral">&#39;only consider pose pairs that have a distance of delta delta_unit (e.g., for evaluating the drift per second/meter/radian)&#39;</span>, action=<span class="stringliteral">&#39;store_true&#39;</span>)
<a name="l00201"></a>00201     parser.add_argument(<span class="stringliteral">&#39;--delta&#39;</span>, help=<span class="stringliteral">&#39;delta for evaluation (default: 1.0)&#39;</span>,default=1.0)
<a name="l00202"></a>00202     parser.add_argument(<span class="stringliteral">&#39;--delta_unit&#39;</span>, help=<span class="stringliteral">&#39;unit of delta (options: \&#39;s\&#39; for seconds, \&#39;m\&#39; for meters, \&#39;rad\&#39; for radians, \&#39;f\&#39; for frames; default: \&#39;s\&#39;)&#39;</span>,default=<span class="stringliteral">&#39;s&#39;</span>)
<a name="l00203"></a>00203     parser.add_argument(<span class="stringliteral">&#39;--offset&#39;</span>, help=<span class="stringliteral">&#39;time offset between ground-truth and estimated trajectory (default: 0.0)&#39;</span>,default=0.0)
<a name="l00204"></a>00204     parser.add_argument(<span class="stringliteral">&#39;--scale&#39;</span>, help=<span class="stringliteral">&#39;scaling factor for the estimated trajectory (default: 1.0)&#39;</span>,default=1.0)
<a name="l00205"></a>00205     parser.add_argument(<span class="stringliteral">&#39;--save&#39;</span>, help=<span class="stringliteral">&#39;text file to which the evaluation will be saved (format: stamp_est0 stamp_est1 stamp_gt0 stamp_gt1 trans_error rot_error)&#39;</span>)
<a name="l00206"></a>00206     parser.add_argument(<span class="stringliteral">&#39;--plot&#39;</span>, help=<span class="stringliteral">&#39;plot the result to a file (requires --fixed_delta, output format: png)&#39;</span>)
<a name="l00207"></a>00207     parser.add_argument(<span class="stringliteral">&#39;--verbose&#39;</span>, help=<span class="stringliteral">&#39;print all evaluation data (otherwise, only the mean translational error measured in meters will be printed)&#39;</span>, action=<span class="stringliteral">&#39;store_true&#39;</span>)
<a name="l00208"></a><a class="code" href="namespaceevaluate__rpe.html#a56386c6923153a0b54fd0ad08f6f65c5">00208</a>     args = parser.parse_args()
<a name="l00209"></a>00209     
<a name="l00210"></a>00210     <span class="keywordflow">if</span> args.plot <span class="keywordflow">and</span> <span class="keywordflow">not</span> args.fixed_delta:
<a name="l00211"></a>00211         sys.exit(<span class="stringliteral">&quot;The &#39;--plot&#39; option can only be used in combination with &#39;--fixed_delta&#39;&quot;</span>)
<a name="l00212"></a>00212     
<a name="l00213"></a><a class="code" href="namespaceevaluate__rpe.html#ac91265aa37e1ddd09b73a62cbd87cff2">00213</a>     traj_gt = <a class="code" href="namespaceevaluate__rpe.html#ab83a4ad6c2bb23eb848257400e3af2de">read_trajectory</a>(args.groundtruth_file)
<a name="l00214"></a><a class="code" href="namespaceevaluate__rpe.html#a025671b200f5b7a0983a6514e9361922">00214</a>     traj_est = <a class="code" href="namespaceevaluate__rpe.html#ab83a4ad6c2bb23eb848257400e3af2de">read_trajectory</a>(args.estimated_file)
<a name="l00215"></a>00215     
<a name="l00216"></a><a class="code" href="namespaceevaluate__rpe.html#ab9508f475c7a0dbbf54aae3a3de416cd">00216</a>     result = <a class="code" href="namespaceevaluate__rpe.html#a8f86ada4c8601d2ee8511fef28455af8">evaluate_trajectory</a>(traj_gt,
<a name="l00217"></a>00217                                  traj_est,
<a name="l00218"></a>00218                                  int(args.max_pairs),
<a name="l00219"></a>00219                                  args.fixed_delta,
<a name="l00220"></a>00220                                  float(args.delta),
<a name="l00221"></a>00221                                  args.delta_unit,
<a name="l00222"></a>00222                                  float(args.offset),
<a name="l00223"></a>00223                                  float(args.scale))
<a name="l00224"></a>00224     
<a name="l00225"></a><a class="code" href="namespaceevaluate__rpe.html#ad2a6d660fb1694231301ffcc7fe4001c">00225</a>     stamps = numpy.array(result)[:,0]
<a name="l00226"></a><a class="code" href="namespaceevaluate__rpe.html#a04edc68697ce323bd19a5d3ab23622dd">00226</a>     trans_error = numpy.array(result)[:,4]
<a name="l00227"></a><a class="code" href="namespaceevaluate__rpe.html#a6e6734ce44f0b67ec6abd7b97ceccde7">00227</a>     rot_error = numpy.array(result)[:,5]
<a name="l00228"></a>00228     
<a name="l00229"></a>00229     <span class="keywordflow">if</span> args.save:
<a name="l00230"></a><a class="code" href="namespaceevaluate__rpe.html#ac861fec3070585727296cd81c3f2bfce">00230</a>         f = open(args.save,<span class="stringliteral">&quot;w&quot;</span>)
<a name="l00231"></a>00231         f.write(<span class="stringliteral">&quot;\n&quot;</span>.join([<span class="stringliteral">&quot; &quot;</span>.join([<span class="stringliteral">&quot;%f&quot;</span>%v <span class="keywordflow">for</span> v <span class="keywordflow">in</span> line]) <span class="keywordflow">for</span> line <span class="keywordflow">in</span> result]))
<a name="l00232"></a>00232         f.close()
<a name="l00233"></a>00233     
<a name="l00234"></a>00234     <span class="keywordflow">if</span> args.verbose:
<a name="l00235"></a>00235         <span class="keywordflow">print</span> <span class="stringliteral">&quot;compared_pose_pairs %d pairs&quot;</span>%(len(trans_error))
<a name="l00236"></a>00236 
<a name="l00237"></a>00237         <span class="keywordflow">print</span> <span class="stringliteral">&quot;translational_error.rmse %f m&quot;</span>%numpy.sqrt(numpy.dot(trans_error,trans_error) / len(trans_error))
<a name="l00238"></a>00238         <span class="keywordflow">print</span> <span class="stringliteral">&quot;translational_error.mean %f m&quot;</span>%numpy.mean(trans_error)
<a name="l00239"></a>00239         <span class="keywordflow">print</span> <span class="stringliteral">&quot;translational_error.median %f m&quot;</span>%numpy.median(trans_error)
<a name="l00240"></a>00240         <span class="keywordflow">print</span> <span class="stringliteral">&quot;translational_error.std %f m&quot;</span>%numpy.std(trans_error)
<a name="l00241"></a>00241         <span class="keywordflow">print</span> <span class="stringliteral">&quot;translational_error.min %f m&quot;</span>%numpy.min(trans_error)
<a name="l00242"></a>00242         <span class="keywordflow">print</span> <span class="stringliteral">&quot;translational_error.max %f m&quot;</span>%numpy.max(trans_error)
<a name="l00243"></a>00243 
<a name="l00244"></a>00244         <span class="keywordflow">print</span> <span class="stringliteral">&quot;rotational_error.rmse %f deg&quot;</span>%(numpy.sqrt(numpy.dot(rot_error,rot_error) / len(rot_error)) * 180.0 / numpy.pi)
<a name="l00245"></a>00245         <span class="keywordflow">print</span> <span class="stringliteral">&quot;rotational_error.mean %f deg&quot;</span>%(numpy.mean(rot_error) * 180.0 / numpy.pi)
<a name="l00246"></a>00246         <span class="keywordflow">print</span> <span class="stringliteral">&quot;rotational_error.median %f deg&quot;</span>%numpy.median(rot_error)
<a name="l00247"></a>00247         <span class="keywordflow">print</span> <span class="stringliteral">&quot;rotational_error.std %f deg&quot;</span>%(numpy.std(rot_error) * 180.0 / numpy.pi)
<a name="l00248"></a>00248         <span class="keywordflow">print</span> <span class="stringliteral">&quot;rotational_error.min %f deg&quot;</span>%(numpy.min(rot_error) * 180.0 / numpy.pi)
<a name="l00249"></a>00249         <span class="keywordflow">print</span> <span class="stringliteral">&quot;rotational_error.max %f deg&quot;</span>%(numpy.max(rot_error) * 180.0 / numpy.pi)
<a name="l00250"></a>00250     <span class="keywordflow">else</span>:
<a name="l00251"></a>00251         <span class="keywordflow">print</span> numpy.mean(trans_error)
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="keywordflow">if</span> args.plot:    
<a name="l00254"></a>00254         <span class="keyword">import</span> matplotlib
<a name="l00255"></a>00255         matplotlib.use(<span class="stringliteral">&#39;Agg&#39;</span>)
<a name="l00256"></a>00256         <span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt
<a name="l00257"></a>00257         <span class="keyword">import</span> matplotlib.pylab <span class="keyword">as</span> pylab
<a name="l00258"></a><a class="code" href="namespaceevaluate__rpe.html#a83d8d36e0070f6ae0208a1c34e66aa5a">00258</a>         fig = plt.figure()
<a name="l00259"></a><a class="code" href="namespaceevaluate__rpe.html#acec35b582c8cf510ceb59cf453886e5f">00259</a>         ax = fig.add_subplot(111)        
<a name="l00260"></a>00260         ax.plot(stamps - stamps[0],trans_error,<span class="stringliteral">&#39;-&#39;</span>,color=<span class="stringliteral">&quot;blue&quot;</span>)
<a name="l00261"></a>00261         <span class="comment">#ax.plot([t for t,e in err_rot],[e for t,e in err_rot],&#39;-&#39;,color=&quot;red&quot;)</span>
<a name="l00262"></a>00262         ax.set_xlabel(<span class="stringliteral">&#39;time [s]&#39;</span>)
<a name="l00263"></a>00263         ax.set_ylabel(<span class="stringliteral">&#39;translational error [m]&#39;</span>)
<a name="l00264"></a>00264         plt.savefig(args.plot,dpi=300)
<a name="l00265"></a>00265         
<a name="l00266"></a>00266 
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


<br clear="all" />
<hr size="1"><div style="align: right;">
<a href="http://ros.org/wiki/lara_rgbd">lara_rgbd</a><br />
Author(s): </br />
<small>autogenerated on Wed Apr 23 2014 16:31:20</small>
</div>
</body>
</html>
